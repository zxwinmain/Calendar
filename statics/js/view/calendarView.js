define(["component","text!templet/calendarView.html","lib/fullcalendar","model/eventModel","view/calendarSelectorView","view/calendar_window_eventSaveView","view/calendar_window_eventView"],function(e,t,n){app.views.calendar=Backbone.View.extend({el:"#workspace",initialize:function(){app.instances.collections.events||(app.instances.collections.events=new app.collections.event),app.instances.collections.events.unbind(),app.instances.collections.events.bind("add",this.insertEvent),app.instances.collections.events.bind("remove",this.removeEvent),app.instances.collections.users.unbind("add",this.refetchEvent),app.instances.collections.users.bind("add",this.refetchEvent),localStorage.getItem("calendar_member")||localStorage.setItem("calendar_member","all"),localStorage.getItem("calendar_state")||localStorage.setItem("calendar_state","all")},packEvent:function(t){var n='<input class="checkbox" type="checkbox"',r=!0,i=new Array;return t||(t=app.instances.collections.events.at(0)),parseInt(t.get("is_done"))==1&&(n+=' checked="checked"',i.push("fc-done")),t.get("id_user")!=app.instances.models.user.get("id")&&(n+=' disabled="disabled"',r=!1,i.push("fc-other-user")),i.push(t.get("className")),{id:t.get("id"),title:n+"><span>"+e.load_user_name(t.get("id_user"))+" "+t.get("name")+"</span>",start:moment.unix(t.get("start")).format("YYYY-MM-DD"),end:moment.unix(parseInt(t.get("end"))+86400).format("YYYY-MM-DD"),className:i,allDay:!0,is_done:t.get("is_done"),editable:r}},insertEvent:function(e){$("#calendarContainer").fullCalendar("renderEvent",app.instances.views.calendar.packEvent(e))},refetchEvent:function(){$("#calendarContainer").fullCalendar("refetchEvents")},removeEvent:function(e){$("#calendarContainer").fullCalendar("removeEvents",e.get("id"))},render:function(){this.template=_.template(t),$(this.el).html(this.template());var e=localStorage.getItem("locale")||"en-us";return e!="en-us"?require(["lib/fullcalendar-lang/"+e],this.calendarRender):this.calendarRender(),this},calendarRender:function(){var t=!1;localStorage.getItem("timezone")&&(t=localStorage.getItem("timezone")),$("#calendarContainer").fullCalendar({lang:localStorage.getItem("locale")||"en-us",timezone:t,fixedWeekCount:!1,editable:!0,header:{left:"prev,next title",right:""},loading:function(e,t){e?$(".fc-view-container").append('<div class="calendarLoading"></div>'):$(".calendarLoading").remove()},eventRender:function(e,t){parseInt(e.is_done)==1&&t.find("span.fc-title").addClass("completed"),t.find("span.fc-title").html(t.find("span.fc-title").text())},dayClick:function(t,n,r){e.component_window(null),(new app.views.calendar_window_eventSave).render(t.format("YYYY-MM-DD"))},eventClick:function(t,n,r){var i=app.instances.collections.events.query({id:t.id}),s=i[0].get("id_user"),o=$(n.target);n.target.className=="checkbox"?(o.attr("disabled","disabled"),o.is(":checked")?(e.api_call("/api/events/"+t.id+"/status","PUT",{IS_DONE:1},function(e){i[0].set("is_done",1)}),o.parents(".fc-title").removeClass("completed").addClass("completed")):(e.api_call("/api/events/"+t.id+"/status","PUT",{IS_DONE:0},function(e){i[0].set("is_done",0)}),o.parents(".fc-title").removeClass("completed"))):s==app.instances.models.user.get("id")?(e.component_window(null),(new app.views.calendar_window_eventSave(i[0])).render()):(e.component_window(null),(new app.views.calendar_window_event(i[0])).render())},events:function(e,t,n,r){var i=$("#calendarContainer").fullCalendar("getView");app.instances.collections.events.fechXhr&&app.instances.collections.events.fechXhr.readyState>0&&app.instances.collections.events.fechXhr.readyState<4&&app.instances.collections.events.fechXhr.abort(),app.instances.collections.events.fechXhr=app.instances.collections.events.fetch({reset:!0,data:{start:i.start.unix(),end:i.end.unix(),member:localStorage.getItem("calendar_member"),state:localStorage.getItem("calendar_state")},success:function(){if(app.instances.views.calendar){var n=[],i=app.instances.collections.events.query({$or:{start:{$between:[e.unix(),t.unix()]},end:{$lte:t.unix()}}});_.each(i,function(e){n.push(app.instances.views.calendar.packEvent(e))}),r(n)}}})},eventDrop:function(e,t,n){var r=app.instances.collections.events.query({id:e.id});r[0].set("start",e.start.unix()),r[0].set("end",parseInt(e.end.unix())-86400),r[0].save()},eventResize:function(e,t,n){var r=app.instances.collections.events.query({id:e.id});r[0].set("start",e.start.unix()),r[0].set("end",parseInt(e.end.unix())-86400),r[0].save()}}),(new app.views.calendarSelector).render()}})});