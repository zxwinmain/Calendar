define(["i18n!nls/locale","component","text!templet/storageView.html","text!templet/storageFolderItemView.html","text!templet/storageFileItemView.html","moment","moment-timezone"],function(e,t,n,r,i,s){app.views.storage=Backbone.View.extend({el:"#workspace",folder:"",parentFolder:null,events:{"click #button_home":"onClickHome","click #button_back":"onClickBack","click #button_save_folder":"onClickCreateFolder","click #button_upload":"onClickUpload","click a.folder":"onClickFolder","click a.deleteFolder":"onClickDeleteFolder","click a.deleteFile":"onClickDeleteFile","click a.renameFolder":"onClickRenameFolder","click a.renameFile":"onClickRenameFile"},onClickHome:function(){this.folder="",this.renderFiles()},onClickBack:function(){this.folder=this.parentFolder,this.renderFiles()},onClickCreateFolder:function(){$("#input_folder").val()?t.api_call("/api/storage/folders","POST",{ID_FOLDER:this.folder,BODY_NAME:$("#input_folder").val()},function(e){app.instances.views.storage.renderFiles(),$("#input_folder").val("")}):t.alert({TITLE:e.root.dialog.title_error,MESSAGE:e.root.dialog.content_not_completed,BUTTON_TRUE_TITLE:e.root.dialog.button_true})},onClickUpload:function(){$("#input_file").click()},onClickFolder:function(e){var t=$(e.currentTarget);this.folder=t.parents("tr").attr("id"),this.renderFiles()},onClickDeleteFolder:function(n){var r=$(n.currentTarget),i=r.parents("tr").attr("id");t.confirm({TITLE:e.root.dialog.title_confirm,MESSAGE:e.root.component_window.common.title_delete_confirm,BUTTON_TRUE_TITLE:e.root.dialog.button_true,BUTTON_FALSE_TITLE:e.root.dialog.button_false,CALLBACK_TRUE:_.bind(function(){t.dialogRemove(),this.deleteFolder(i),t.component_window_remove()},this)})},onClickDeleteFile:function(n){var r=$(n.currentTarget),i=r.parents("tr").attr("id");t.confirm({TITLE:e.root.dialog.title_confirm,MESSAGE:e.root.component_window.common.title_delete_confirm,BUTTON_TRUE_TITLE:e.root.dialog.button_true,BUTTON_FALSE_TITLE:e.root.dialog.button_false,CALLBACK_TRUE:_.bind(function(){t.dialogRemove(),this.deleteFile(i),t.component_window_remove()},this)})},onClickRenameFolder:function(n){var r=$(n.currentTarget),i=r.parents("tr").attr("id");t.prompt({TITLE:e.root.dialog.storage_new_folder_name,MESSAGE:r.parents("tr").find("td.name a").html(),BUTTON_TRUE_TITLE:e.root.dialog.button_true,BUTTON_FALSE_TITLE:e.root.dialog.button_false,CALLBACK_TRUE:_.bind(function(){this.renameFolder(i,$("#callback_input").val()),t.dialogRemove(),t.component_window_remove()},this)})},onClickRenameFile:function(n){var r=$(n.currentTarget),i=r.parents("tr").attr("id");t.prompt({TITLE:e.root.dialog.storage_new_file_name,MESSAGE:r.parents("tr").find("td.name").html(),BUTTON_TRUE_TITLE:e.root.dialog.button_true,BUTTON_FALSE_TITLE:e.root.dialog.button_false,CALLBACK_TRUE:_.bind(function(){this.renameFile(i,$("#callback_input").val()),t.dialogRemove(),t.component_window_remove()},this)})},renameFolder:function(e,n){t.api_call("/api/storage/folders/"+e,"PUT",{NAME:n},function(e){app.instances.views.storage&&app.instances.views.storage.renderFiles()})},renameFile:function(e,n){t.api_call("/api/storage/files/"+e,"PUT",{NAME:n},function(e){app.instances.views.storage&&app.instances.views.storage.renderFiles()})},deleteFolder:function(e){t.api_call("/api/storage/folders/"+e,"DELETE",{},function(e){app.instances.views.storage&&app.instances.views.storage.renderFiles()})},deleteFile:function(e){t.api_call("/api/storage/files/"+e,"DELETE",{},function(e){app.instances.views.storage&&app.instances.views.storage.renderFiles()})},renderLoading:function(){$("table.storageList tbody").html("").append($("#span_loading").html())},renderFiles:function(){this.renderLoading(),t.api_call("/api/storage/files","GET",{ID_FOLDER:this.folder},function(e){if(app.instances.views.storage){$("table.storageList tbody").html(""),e.response.ID_FOLDER?(app.instances.views.storage.parentFolder=e.response.ID_FOLDER,$("#button_back").css("visibility","visible")):(app.instances.views.storage.parentFolder=null,$("#button_back").css("visibility","hidden")),!app.instances.views.storage.parentFolder&&app.instances.views.storage.folder&&$("#button_back").css("visibility","visible");if(!e.response.FOLDERS.length&&!e.response.FILES.length)$("table.storageList tbody").html("").append($("#span_null").html());else{var n=_.template(r),o=_.template(i);for(var u=0;u<e.response.FOLDERS.length;u++)$("table.storageList tbody").append(n({ID:e.response.FOLDERS[u].ID,NAME:e.response.FOLDERS[u].BODY_NAME}));for(var u=0;u<e.response.FILES.length;u++){var a=app.instances.collections.users.where({id:e.response.FILES[u].ID_USER}),f=s.unix(e.response.FILES[u].TIME_CREATED).tz(localStorage.getItem("timezone")).format("YYYY-MM-DD HH:mm:ss");parseInt(e.response.FILES[u].TIME_UPDATED)>0&&(f=s.unix(e.response.FILES[u].TIME_UPDATED).tz(localStorage.getItem("timezone")).format("YYYY-MM-DD HH:mm:ss")),$("table.storageList tbody").append(o({ID:e.response.FILES[u].ID,NAME:e.response.FILES[u].BODY_NAME,USER:a[0].get("name"),SIZE:t.bytes_to_size(e.response.FILES[u].BODY_SIZE),TIME:f}))}}}})},render:function(){return this.template=_.template(n),this.$el.html(this.template()),this.renderFiles(),$("#input_file").AjaxFileUpload({action:"/api/upload",onSubmit:function(){$("#button_upload").attr("disabled","disabled").addClass("disabled")},onComplete:function(n,r){$("#button_upload").removeAttr("disabled").removeClass("disabled"),r.succeed?t.api_call("/api/storage/files","POST",{ID_FOLDER:app.instances.views.storage.folder,FILE_NAME:n,FILE_URL:r.response},function(e){app.instances.views.storage&&app.instances.views.storage.renderFiles()}):(r.response=="INVALID_FILE_TYPE"&&t.alert({TITLE:e.root.dialog.title_error,MESSAGE:e.root.dialog.file_invalid,BUTTON_TRUE_TITLE:e.root.dialog.button_true}),r.response=="NO_FILE_UPLOADED"&&t.alert({TITLE:e.root.dialog.title_error,MESSAGE:e.root.dialog.file_no_uploaded,BUTTON_TRUE_TITLE:e.root.dialog.button_true}))}}),this}})});