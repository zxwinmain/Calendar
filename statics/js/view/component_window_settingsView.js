define(["i18n!nls/locale","component","text!templet/component_window_settingsView.html","moment-timezone","jquery.ajaxfileupload"],function(e,t,n,r){app.views.component_window_settings=Backbone.View.extend({el:"#component_window_wrapper",events:{"click ul.swicher a":function(e){t.component_window_tab(e)},"click #button_save_profile":"onSaveProfile","click #button_save_locale":"onSaveLocale","click #button_save_avatar":"onSaveAvatar","click #button_save_system":"onSaveSystem","click a.administrator":"onSetAdministrator","click a.resetPassword":"onResetPassword","click a.delete":"onDeleteUser","click a.block":"onBlockUser","click #button_save_new_user":"onInviteUser"},onSaveProfile:function(){var n=$("input[name=USER_EMAIL]").val(),r=$("input[name=USER_NAME]").val(),i=$("input[name=USER_PASSWORD]").val(),s=1;!n||!r?(s=0,t.alert({TITLE:e.root.dialog.title_error,MESSAGE:e.root.dialog.content_not_completed,BUTTON_TRUE_TITLE:e.root.dialog.button_true})):t.isEmail(n)||(s=0,t.alert({TITLE:e.root.dialog.title_error,MESSAGE:e.root.dialog.signin_invalid_email,BUTTON_TRUE_TITLE:e.root.dialog.button_true})),i&&(t.isPassword($("input[name=USER_PASSWORD]").val())||(s=0,t.alert({TITLE:e.root.dialog.title_error,MESSAGE:e.root.dialog.signin_invalid_password,BUTTON_TRUE_TITLE:e.root.dialog.button_true})),app.instances.models.user.set("password",$("input[name=USER_PASSWORD]").val())),s&&(app.instances.models.user.set("name",$("input[name=USER_NAME]").val()),app.instances.models.user.set("intro",$("textarea[name=USER_INTRO]").val()),app.instances.models.user.save(),app.instances.models.user.unset("password"),t.component_window_remove())},onSaveLocale:function(){localStorage.setItem("locale",$("select[name=USER_LANGUAGE]").val()),localStorage.setItem("timezone",$("select[name=USER_TIMEZONE]").val()),location.reload()},onSaveAvatar:function(){app.instances.models.user.set("avatar",$("#avatar_preview").attr("src")),app.instances.models.user.save(),t.component_window_remove()},onSaveSystem:function(){var n=$("input[name=SYSTEM_NAME]").val(),r=1;n||(r=0,t.alert({TITLE:e.root.dialog.title_error,MESSAGE:e.root.dialog.content_not_completed,BUTTON_TRUE_TITLE:e.root.dialog.button_true})),r&&(app.instances.models.account.set("name",$("input[name=SYSTEM_NAME]").val()),app.instances.models.account.save(),t.component_window_remove())},onSetAdministrator:function(n){var r=$(n.currentTarget).parents("dd").attr("id"),i=app.instances.collections.users.where({id:r});i[0].get("is_administrator")==1?t.confirm({TITLE:e.root.dialog.title_confirm,MESSAGE:e.root.component_window.settings.system_members_administrator_false,BUTTON_TRUE_TITLE:e.root.dialog.button_true,BUTTON_FALSE_TITLE:e.root.dialog.button_false,CALLBACK_TRUE:function(){t.api_call("/api/users/"+r+"/administrator","PUT",{IS_ADMINISTRATOR:0},function(e){t.dialogRemove()})}}):t.confirm({TITLE:e.root.dialog.title_confirm,MESSAGE:e.root.component_window.settings.system_members_administrator_true,BUTTON_TRUE_TITLE:e.root.dialog.button_true,BUTTON_FALSE_TITLE:e.root.dialog.button_false,CALLBACK_TRUE:function(){t.api_call("/api/users/"+r+"/administrator","PUT",{IS_ADMINISTRATOR:1},function(e){t.dialogRemove()})}})},onResetPassword:function(n){var r=$(n.currentTarget).parents("dd").attr("id");t.confirm({TITLE:e.root.dialog.title_confirm,MESSAGE:e.root.component_window.settings.system_members_resetPassword,BUTTON_TRUE_TITLE:e.root.dialog.button_true,BUTTON_FALSE_TITLE:e.root.dialog.button_false,CALLBACK_TRUE:function(){t.api_call("/api/users/"+r+"/password","PUT",{},function(e){t.dialogRemove()})}})},onDeleteUser:function(n){var r=$(n.currentTarget).parents("dd").attr("id");t.confirm({TITLE:e.root.dialog.title_confirm,MESSAGE:e.root.component_window.settings.system_members_delete,BUTTON_TRUE_TITLE:e.root.dialog.button_true,BUTTON_FALSE_TITLE:e.root.dialog.button_false,CALLBACK_TRUE:function(){t.api_call("/api/users/"+r,"DELETE",{},function(e){t.dialogRemove()})}})},onBlockUser:function(n){var r=$(n.currentTarget).parents("dd").attr("id"),i=app.instances.collections.users.where({id:r});i[0].get("time_deleted")==0?t.confirm({TITLE:e.root.dialog.title_confirm,MESSAGE:e.root.component_window.settings.system_members_block_true,BUTTON_TRUE_TITLE:e.root.dialog.button_true,BUTTON_FALSE_TITLE:e.root.dialog.button_false,CALLBACK_TRUE:function(){t.api_call("/api/users/"+r+"/block","PUT",{IS_BLOCKED:1},function(e){t.dialogRemove()})}}):t.confirm({TITLE:e.root.dialog.title_confirm,MESSAGE:e.root.component_window.settings.system_members_block_false,BUTTON_TRUE_TITLE:e.root.dialog.button_true,BUTTON_FALSE_TITLE:e.root.dialog.button_false,CALLBACK_TRUE:function(){t.api_call("/api/users/"+r+"/block","PUT",{IS_BLOCKED:0},function(e){t.dialogRemove()})}})},onInviteUser:function(){var n=$("#input_save_new_user_email").val(),r=$("#input_save_new_user_name").val();!n||!r?t.alert({TITLE:e.root.dialog.title_error,MESSAGE:e.root.dialog.content_not_completed,BUTTON_TRUE_TITLE:e.root.dialog.button_true}):t.isEmail(n)?t.api_call("/api/users","POST",{USER_EMAIL:n,USER_NAME:r},function(n){t.alert({TITLE:e.root.dialog.title_ok,MESSAGE:e.root.dialog.invited,BUTTON_TRUE_TITLE:e.root.dialog.button_true}),$("#input_save_new_user_email").val(""),$("#input_save_new_user_name").val("")}):t.alert({TITLE:e.root.dialog.title_error,MESSAGE:e.root.dialog.signin_invalid_email,BUTTON_TRUE_TITLE:e.root.dialog.button_true})},render:function(i){return this.template=_.template(n),this.$el.html(this.template({USER_EMAIL:app.instances.models.user.get("email"),USER_NAME:app.instances.models.user.get("name"),USER_INTRO:app.instances.models.user.get("intro"),TIMEZONES:r.tz.names(),SYSTEM_NAME:app.instances.models.account.get("name")})),$("ul.swicher li:first-child a").addClass("active"),$("#input_save_avatar").AjaxFileUpload({action:"/api/upload/avatar",onComplete:function(n,r){r.succeed?$("#avatar_preview").attr("src",r.response):(r.response=="INVALID_FILE_TYPE"&&t.alert({TITLE:e.root.dialog.title_error,MESSAGE:e.root.dialog.file_invalid,BUTTON_TRUE_TITLE:e.root.dialog.button_true}),r.response=="NO_FILE_UPLOADED"&&t.alert({TITLE:e.root.dialog.title_error,MESSAGE:e.root.dialog.file_no_uploaded,BUTTON_TRUE_TITLE:e.root.dialog.button_true}))}}),app.instances.collections.users.on("add",this.userListAdd),app.instances.collections.users.on("remove",this.userListRemove),this},userListAdd:function(e){$("#userList").append('<dd id="'+e.get("id")+'"><div class="left"></div><div class="right"><a class="administrator icon-flash"></a><a class="resetPassword icon-ccw"></a><a class="block icon-minus-circled"></a><a class="delete icon-cancel"></a></div></dd>'),$("#"+e.get("id")).find("div.left").html('<span class="name">'+e.get("name")+'</span><span class="email">'+e.get("email")+"</span>"),e.get("is_administrator")=="1"&&$("#"+e.get("id")).find("span.name").css("color","red"),parseInt(e.get("time_deleted"))>0&&$("#"+e.get("id")).find("span.name").css("color","#ccc")},userListRemove:function(e){$("#"+e.get("id")).remove()}})});