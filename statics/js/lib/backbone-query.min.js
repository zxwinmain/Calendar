var __slice=[].slice,__hasProp={}.hasOwnProperty,__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};(function(e){return e("backbone-query",function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;return w=e("underscore"),n=e("backbone"),i=function(e,t){var n,r,i,s;s=[];for(r=0,i=e.length;r<i;r++)n=e[r],t(n)&&s.push(n);return s},v=function(e,t){var n,r,i,s;s=[];for(r=0,i=e.length;r<i;r++)n=e[r],t(n)||s.push(n);return s},r=function(e,t){var n,r,i;for(r=0,i=e.length;r<i;r++){n=e[r];if(t(n))return!0}return!1},f=function(){var e,t,n,r,i;e=1<=arguments.length?__slice.call(arguments,0):[],r={},t=r;while(e.length)n=e.shift(),i=e.length===1?e.shift():{},t=t[n]=i;return r},u=function(e){return w.isRegExp(e)?"$regex":w.isDate(e)?"$date":w.isObject(e)&&!w.isArray(e)?"object":w.isArray(e)?"array":w.isString(e)?"string":w.isNumber(e)?"number":w.isBoolean(e)?"boolean":w.isFunction(e)?"function":!1},h=function(e){var t,n,r,i,s,o,a,l,p,d,v,m,g;w.isArray(e)?o=e:o=function(){var n;n=[];for(t in e){if(!__hasProp.call(e,t))continue;p=e[t],n.push(f(t,p))}return n}(),g=[];for(v=0,m=o.length;v<m;v++){s=o[v];for(t in s){if(!__hasProp.call(s,t))continue;a=s[t],n={key:t},r=u(a);switch(r){case"$regex":case"$date":n.type=r,n.value=a;break;case"object":if(t==="$and"||t==="$or"||t==="$nor"||t==="$not")n.value=h(a),n.type=t,n.key=null;else for(l in a){d=a[l];if(b(l,d)){n.type=l;switch(l){case"$elemMatch":case"$relationMatch":n.value=c(d);break;case"$computed":i=f(t,d),n.value=h(i);break;default:n.value=d}}}break;default:n.type="$equal",n.value=a}n.type==="$equal"&&(r==="object"||r==="array")&&(n.type="$oEqual")}g.push(n)}return g},b=function(e,t){switch(e){case"$in":case"$nin":case"$all":case"$any":return w(t).isArray();case"$size":return w(t).isNumber();case"$regex":return w(t).isRegExp();case"$like":case"$likeI":return w(t).isString();case"$between":return w(t).isArray()&&t.length===2;case"$cb":return w(t).isFunction();default:return!0}},y=function(e,t){switch(e){case"$like":case"$likeI":case"$regex":return w(t).isString();case"$contains":case"$all":case"$any":case"$elemMatch":return w(t).isArray();case"$size":return w(t).isArray()||w(t).isString();case"$in":case"$nin":return t!=null;case"$relationMatch":return t!=null&&t.models;default:return!0}},p=function(e,t,n,i,s){switch(e){case"$equal":return w(n).isArray()?__indexOf.call(n,t)>=0:n===t;case"$oEqual":return w(n).isEqual(t);case"$contains":return __indexOf.call(n,t)>=0;case"$ne":return n!==t;case"$lt":return n<t;case"$gt":return n>t;case"$lte":return n<=t;case"$gte":return n>=t;case"$between":return t[0]<n&&n<t[1];case"$in":return __indexOf.call(t,n)>=0;case"$nin":return __indexOf.call(t,n)<0;case"$all":return w(t).all(function(e){return __indexOf.call(n,e)>=0});case"$any":return w(n).any(function(e){return __indexOf.call(t,e)>=0});case"$size":return n.length===t;case"$exists":case"$has":return n!=null===t;case"$like":return n.indexOf(t)!==-1;case"$likeI":return n.toLowerCase().indexOf(t.toLowerCase())!==-1;case"$regex":return t.test(n);case"$cb":return t.call(i,n);case"$elemMatch":return m(n,t,"elemMatch").length>0;case"$relationMatch":return m(n.models,t,"relationMatch").length>0;case"$computed":return a([i],t,!1,r,"computed");case"$and":case"$or":case"$nor":case"$not":return d[e]([i],t).length===1;default:return!1}},a=function(e,t,n,r,i){return i==null&&(i=!1),r(e,function(e){var r,s,o,u,a;for(u=0,a=t.length;u<a;u++){s=t[u],r=function(){switch(i){case"elemMatch":return e[s.key];case"computed":return e[s.key]();default:return e.get(s.key)}}(),o=y(s.type,r),o&&(o=p(s.type,s.value,r,e,s.key));if(n===o)return n}return!n})},d={$and:function(e,t,n){return a(e,t,!1,i,n)},$or:function(e,t,n){return a(e,t,!0,i,n)},$nor:function(e,t,n){return a(e,t,!0,v,n)},$not:function(e,t,n){return a(e,t,!1,v,n)}},c=function(e){var t,n,r,i,s,o;i=w(e).keys(),t=["$and","$not","$or","$nor"],n=w.intersection(t,i);if(n.length===0)return[{type:"$and",parsedQuery:h(e)}];if(n.length!==i.length){__indexOf.call(n,"$and")<0&&(e.$and={},n.unshift("$and"));for(r in e){if(!__hasProp.call(e,r))continue;o=e[r];if(!(__indexOf.call(t,r)<0))continue;e.$and[r]=o,delete e[r]}}return function(){var t,r,i;i=[];for(t=0,r=n.length;t<r;t++)s=n[t],i.push({type:s,parsedQuery:h(e[s])});return i}()},m=function(e,t,n){var r;return n||(t=c(t)),r=function(e,t){return d[t.type](e,t.parsedQuery,n)},w.reduce(t,r,e)},s=function(e,t,n){var r,i,s,u;return s=JSON.stringify(t),r=(u=e._queryCache)!=null?u:e._queryCache={},i=r[s],i||(i=o(e,t,n),r[s]=i),i},o=function(e,t,n){var r;return r=m(e.models,t),n.sortBy&&(r=g(r,n)),r},g=function(e,t){return w(t.sortBy).isString()?e=w(e).sortBy(function(e){return e.get(t.sortBy)}):w(t.sortBy).isFunction()&&(e=w(e).sortBy(t.sortBy)),t.order==="desc"&&(e=e.reverse()),e},l=function(e,t){var n,r,i,s;return t.offset?i=t.offset:t.page?i=(t.page-1)*t.limit:i=0,n=i+t.limit,r=e.slice(i,n),t.pager&&w.isFunction(t.pager)&&(s=Math.ceil(e.length/t.limit),t.pager(s,r)),r},n.QueryCollection=n.Collection.extend({query:function(e,t){var n;return t==null&&(t={}),t.cache?n=s(this,e,t):n=o(this,e,t),t.limit&&(n=l(n,t)),n},findOne:function(e){return this.query(e)[0]},whereBy:function(e,t){return t==null&&(t={}),new this.constructor(this.query(e,t))},resetQueryCache:function(){return this._queryCache={}}}),t.QueryCollection=n.QueryCollection})}).call(this,typeof define=="function"&&define.amd?define:function(e,t){typeof exports!="undefined"?t(function(e){return require(e)},exports):t(function(e){return this[e==="underscore"?"_":"Backbone"]},{})});